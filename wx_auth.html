<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="target-densitydpi=device-dpi, width=640px, user-scalable=no">
  <meta name="format-detection" content="telephone=no">
  <title>微信授权</title>
</head>
<body>
<script>
/**
 * 获取微信用户信息
 */
function getWxUserInfo(code, redirect_url) {
  var str = sessionStorage.getItem('referreId');
  !str ? referreId = '' :  referreId = str;
  var xhr = new XMLHttpRequest()
  xhr.open('GET', '/api/wechat/getUserInfo?code='+code + '&referreId=' + referreId);
  xhr.send()
  xhr.onreadystatechange = function () {
    if (xhr.readyState === 4) {
      var data = JSON.parse(xhr.responseText)
      if(data.code == 200) {
        localStorage.setItem('wx_openid', data.data.openid)
        localStorage.setItem('wx_unionid', data.data.unionid)
        localStorage.setItem('uid', data.data.id)
        window.location.href = redirect_url
      } else {
        alert(data.msg)
      }
    }
  }
}

const redirect_url = '/'
var code = getQueryVariable('code');
if(!code) {
  alert('code required');
} else {
  getWxUserInfo(code, 'index.html');
}
</script>
</body>
</html>
